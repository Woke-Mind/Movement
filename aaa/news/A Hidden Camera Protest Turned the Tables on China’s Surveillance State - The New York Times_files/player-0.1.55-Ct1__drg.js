var De=Object.defineProperty,Ie=(e,t,n)=>t in e?De(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,p=(e,t,n)=>Ie(e,"symbol"!=typeof t?t+"":t,n);import{A as U,b as C,u as X,g as L,_ as m,e as H,y as V,d as Ve,h as oe,E as Ue,i as w,T as j,j as Ne,l as Oe,m as Z,x as Fe,c as Ae,C as He}from"./betamax-shared-DH_j5-1B.js";import{u as W,a as he,c as q,l as N,b as O,d as $e,E as We}from"./reduced-motion-rPScagHf.js";import{S as d,V as k}from"./event-types-ylPu1rr5.js";import{u as $,c as Be,a as je,V as ze}from"./video-element-BevtQ4YC.js";import{a as pe}from"./identify-user-NlIHKxju.js";import{h as le}from"./hlsjs-C3vtCYGP.js";const qe="_errorSlate_1jvxz_1",Ge="_playback_1jvxz_9",Je="_alert_1jvxz_19",Ye="_icon_1jvxz_25",Ke="_info_1jvxz_37",Qe="_refresh_1jvxz_43",Xe="_stacked_1jvxz_54",Ze="_message_1jvxz_59",I={errorSlate:qe,playback:Ge,alert:Je,icon:Ye,info:Ke,refresh:Qe,stacked:Xe,message:Ze},et="_container_qb3td_5",tt="_video_qb3td_27",nt="_fit-contain_qb3td_46",rt="_fit-cover_qb3td_47",it="_webkit-fullscreen_qb3td_82",at="_reduced-motion-check-complete_qb3td_93",_={container:et,video:tt,fitContain:nt,fitCover:rt,webkitFullscreen:it,reducedMotionCheckComplete:at};function st(e){const t=U(e.value);return C((()=>{t.current=e.value})),t.current}function ot(e){var t;if(!e)return!1;const n=null==(t=e.currentSrc)?void 0:t.split(".").pop(),a="m3u8"===n?"application/x-mpegURL":`video/${n}`;return!!e.canPlayType(a)}function me(){var e,t;const n=null==(e=X("nyt-betamax"))?void 0:e.lowLevel.videoElement.value,a=null==(t=X("nyt-betamax"))?void 0:t.player,[i]=W(),r=he(),o=U(null),s=st(r),l="playback"===(null==r?void 0:r.value);C((()=>{"playback"===r.value&&"paused"!==(null==a?void 0:a.playState.value)?(o.current="playing"===(null==a?void 0:a.playState.peek()),"playing"===(null==a?void 0:a.playState.value)&&(null==a||a.pause(),o.current=!0)):"playback"===s&&o.current&&null===r.value&&(null==a||a.play(),o.current=null)}));const u=L((()=>{var e;if(!l)return"This video is currently unavailable.";switch(null==(e=i.value)?void 0:e.code){case MediaError.MEDIA_ERR_ABORTED:return"Playback was aborted. Please refresh to try again.";case MediaError.MEDIA_ERR_NETWORK:return"The network connection was lost. Please refresh to try again.";case MediaError.MEDIA_ERR_DECODE:return"There was a playback error. Please refresh to try again.";case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:if(n&&!1===ot(n))return"The selected video format is not supported.";default:return"Unable to play video. Please refresh to try again."}}));return r.value?m("div",{"data-testid":"betamax-error-slate","aria-labelledby":"betamax-error-slate-label",className:H(_.video,I.errorSlate,{[I.playback]:l})},m("span",{className:H(I.alert,l&&I.stacked)},m("span",{className:H(I.icon,{[I.info]:!l,[I.refresh]:l})}),m("span",{id:"betamax-error-slate-label",className:I.message},u.value))):null}class ye extends CustomEvent{constructor(e){super(F+":unmuted",{detail:{videoElement:e}})}}function ue(e){e.target instanceof HTMLVideoElement&&!0!==e.target.muted&&window.dispatchEvent(new ye(e.target))}function lt(e,t,n){function a(t){if(t instanceof ye&&t.detail.videoElement!==e.value){if(!e.value)return console.error("Tried to mute this video in response to another unmuting but it doesn't exist"),void q(new Error("Tried to mute this video in response to another unmuting but it doesn't exist"));"playing"===n.value&&(e.value.muted=!0)}}V((function(){if(!1===t)return;const e=F+":unmuted";return window.addEventListener(e,a),()=>window.removeEventListener(e,a)}),[t])}function ut(){return!(typeof window>"u")&&!(typeof window.__VHS__>"u")}class we extends CustomEvent{constructor(e){super(F+":play",{detail:{videoElement:e}})}}function dt(e){e.target instanceof HTMLVideoElement&&(e.target.muted||window.dispatchEvent(new we(e.target)))}const ct=e=>{const{enabled:t,live:n,playState:a,setUserDrivenPlaystate:i,videoElementRef:r}=e,[o,s]=Ve(!1);"randomUUID"in crypto||console.error("No randomUUID function when there should be one");const l=U("randomUUID"in crypto?crypto.randomUUID():void 0);function u(e){const t=r.value;if(e instanceof we&&e.detail.videoElement!==t){if(!t)return console.error("Tried to pause this video in response to another playing but it doesn't exist"),void q(new Error("Tried to pause this video in response to another playing but it doesn't exist"));"playing"===a.value&&!t.muted&&i("pause")}}return V((()=>{const e=F+":play";return t&&window.addEventListener(e,u),()=>window.removeEventListener(e,u)}),[t]),V((()=>{function e(){ut()&&s(!0)}return typeof window<"u"&&window.addEventListener("load",e),()=>{window.removeEventListener("load",e)}}),[]),V((()=>{if(null===r.value||!o)return;const e=r.value,a={isBetamax:()=>!0,isLive:()=>n,isMuted:()=>e.muted,mute:t=>{e&&(e.muted=t)},pause:()=>{t&&i("pause")},play:()=>i("play")},s=l.current;return typeof window.__VHS__<"u"&&s&&(window.__VHS__.instances[s]=a),()=>{var e;null!=(e=window.__VHS__)&&e.instances&&s&&delete window.__VHS__.instances[s]}}),[r,o]),V((()=>{"playing"===a.value&&function(){const e=r.value;if(typeof window>"u"||!e||e.muted)return;const t=l.current,{instances:n}=window.__VHS__||{};if(!n)return;Object.keys(n).forEach((e=>{if(e===t)return;const a=n[e];typeof a.isBetamax<"u"||(typeof a.isLive<"u"&&a.isLive()?a.mute(!0):a.isMuted()||a.pause())}))}()}),[a.value]),{uuid:l.current}};function ft(e){return function(t){e.forEach((e=>e(t)))}}function vt(e,t){const n=$(t.onCanPlay),a=$(t.onPause),i=$(t.onPlay),r=t=>e.playState.value=t;return{events:{onPlay:t=>{var n;dt(t),ue(t),r("playing"),null==(n=i.value)||n.call(i),e.buffering.value=!1},onPlaying:()=>{r("playing"),e.buffering.value=!1},onPause:()=>{var t;r("paused"),e.receivedBrowserPauseEvent(),null==(t=a.value)||t.call(a),e.buffering.value=!1},onVolumeChange:ft([t=>{e.muted.value=t.target.muted},ue]),onTimeUpdate:t=>{if(!t.target)return;(t=>{e.currentTime.value=t})(t.target.currentTime)},onLoadedMetadata:t=>{if(!t.target)return;(t=>{e.duration.value=t})(t.target.duration)},onWaiting:()=>{e.buffering.value=!0},onEnded:t=>{var n,i;const o=t.target;o.loop||(o.pause(),r("paused"),null==(n=a.value)||n.call(a),null==(i=e.setUserDrivenPlaystate)||i.call(e,"pause"))},onCanPlay:()=>{var e;null==(e=n.value)||e.call(n)}}}}function ht(e,t){function n(){var n;document.fullscreenElement===t||(null==(n=document.fullscreenElement)?void 0:n.shadowRoot)===t.getRootNode()?e.value=!0:e.value=!1}return window.addEventListener("fullscreenchange",n),{enterFullscreen:()=>{const e=t.querySelector("video"),n=e&&!e.paused;async function a(){if(n&&e&&e.paused)try{return await e.play()}catch(e){throw N("Failed to resume playback in fullscreen:",e),e}return Promise.resolve()}function i(){const e=t.requestFullscreen();return e instanceof Promise?e.then(a):de(a,100)}return n?i():de(i,50)},exitFullscreen:()=>document.exitFullscreen(),teardown(){window.removeEventListener("fullscreenchange",n)}}}function de(e,t){return new Promise(((n,a)=>{setTimeout((()=>{e().then(n).catch(a)}),t)}))}function pt(e,t,n,a,i){const r=oe(e.value),o=oe(!1);function s(){const i="fullscreen"===t.webkitPresentationMode;i!==e.value&&(i||(a.value=!1),i?t.classList.add(_.webkitFullscreen):t.classList.remove(_.webkitFullscreen),e.value=i,r.value="fulfilled",!1===i&&"playing"===n.value&&(o.value=!0,setTimeout((()=>{o.value=!1}),1e3)))}function l(){"fullscreen"===t.webkitPresentationMode&&i("play"),!1===r.value&&"fullscreen"===t.webkitPresentationMode?(a.value=!1,t.webkitSetPresentationMode("inline")):!0===r.value&&"fullscreen"!==t.webkitPresentationMode&&(a.value=!0,t.webkitSetPresentationMode("fullscreen"))}return Ue((()=>{!0===o.value&&"paused"===n.value&&(t.play(),o.value=!1)})),t.addEventListener("webkitpresentationmodechanged",s),t.addEventListener("playing",l),t.addEventListener("pause",(function(){"fullscreen"===t.webkitPresentationMode&&i("pause")})),s(),{enterFullscreen:()=>(r.value=!0,l(),Promise.resolve()),exitFullscreen:()=>(r.value=!1,l(),Promise.resolve()),teardown(){t.removeEventListener("webkitpresentationmodechanged",s),t.removeEventListener("playing",l)}}}function mt(e){e.value="not-supported";const t=()=>Promise.reject(new Error("Fullscreen not supported"));return{enterFullscreen:t,exitFullscreen:t,teardown(){}}}function yt(e,t,n,a,i){const r=w(!1),[,o]=W(),s=U(void 0);let l=null;return C((()=>{if(t.value&&e.current)return"requestFullscreen"in e.current?s.current=ht(r,e.current):"webkitPresentationMode"in t.value?s.current=pt(r,t.value,n,a,i):s.current=mt(r),()=>{var e;null==(e=s.current)||e.teardown()};s.current=void 0})),{fullScreenSignal:r,setFullscreen:async function(e){if(!s.current)throw new Error("Fullscreen implementation is not set, it should always be");if(e){i("play"),l=window.scrollY;try{return await s.current.enterFullscreen()}catch(e){throw N("Failed to enter fullscreen:",e),o(O("failed to enter fullscreen",{type:"playback",cause:e}),!0),e}}else{null!==l&&(window.scrollTo(0,l),l=null);try{return await s.current.exitFullscreen()}catch(e){throw N("Failed to exit fullscreen:",e),o(O("failed to exit fullscreen",{type:"playback",cause:e}),!0),e}}}}}function wt(e){const t=U(new Map);return{play:j((()=>()=>{const n=[];if(t.current.forEach((e=>{const t=e();!0!==t.allowPlayback&&n.push(t.reason)})),0===n.length)return e.wrapping();console.log("[Playback Interceptor] Disallowing playback for reasons: "+n.join(", "))}),[t.current]),registerPlaybackInterceptor:(e,n)=>{t.current.set(e,n)},unregisterPlaybackInterceptor:e=>{t.current.delete(e)}}}const F="nyt-betamax",gt=Ne(F);function Et({buffering:e,captions:t,captionsAvailable:n,children:a,currentTime:i,duration:r,fullscreenSignal:o,muted:s,playState:l,playStateIsUserDriven:u,setFullscreen:c,setUserDrivenPlaystate:v,tracking:p,videoElement:h,visibleOnPageLoad:f,aspectRatio:y}){const{registerPlaybackInterceptor:g,unregisterPlaybackInterceptor:E,play:b}=wt({wrapping:()=>v("play")}),P=w("playing"===l.value);C((()=>{"playing"===l.value&&!0!==P.value&&(P.value=!0)}));const _=w(y);_.value=y;const k={aspectRatio:_,buffering:e,captions:t,captionsAvailable:n,currentTime:i,duration:r,fullscreen:o,hasEverPlayed:P,muted:s,pause:()=>v("pause"),play:b,playState:l,setCaptions:e=>{h.value&&(t.value=e)},setCurrentTime:(e,t=!1)=>{h.value&&(h.value.currentTime=e,t||p.send(d.Seek))},setFullscreen:c,setMuted:e=>{h.value&&(h.value.muted=e)},tracking:p,visibleOnPageLoad:f},S={registerPlaybackInterceptor:g,unregisterPlaybackInterceptor:E,videoElement:h,playStateIsUserDriven:u};return m(gt.Provider,{values:{player:k,lowLevel:S}},a)}function St(e){return"error"in e}let A;function ce(e,t){if(!A)return void console.error("[Betamax analytics] Unified tracking not initialized");const n="hybrid"===A.context&&"mediaEvent"===e?"media":e;let a=t.payload;"hybrid"!==A.context&&"mediaEvent"===e&&(a={event:n,media:t.payload});try{A.sendAnalytic(n,a).then((e=>{if(St(e))throw new Error(e.errorDetails)})).catch((e=>{console.error("[Betamax analytics] Error sending to unified tracking:",e)}))}catch(e){console.error("[Betamax analytics] Error sending to unified tracking:",e)}}typeof window<"u"&&(window.dataLayer||(window.dataLayer=[]),A=Oe.initUnifiedTracking({navigator:{userAgent:navigator.userAgent},NativeBridge:"NativeBridge"in window?window.NativeBridge:void 0,dataLayer:window.dataLayer,vi:!0},{hybridTakesPriorityOverWeb:!0}));const Pt=[d.Resume,d.Mute,d.Unmute,d.Pause,d.Rebuffering,d.InView,d.AutoLoop,d.UserLoop,d.ExitFullscreen,d.EnterFullscreen,d.Seek,d.Stalled,d.ExitCaptions,d.EnterCaptions,d.ModuleInteraction];class bt{constructor(){p(this,"sentEvents",new Set)}send(e){this.isDuplicateEvent(e.event)||(this.sentEvents.add(e.event),ce("mediaEvent",e))}isDuplicateEvent(e){return this.sentEvents.has(e)&&!Pt.includes(e)}sendCustomEvent(e){this.isDuplicateEvent(e.event)||ce(e.event,{event:e.event,payload:e})}}function kt(e,t){let n=0;return function(...a){const i=(new Date).getTime();i-n>=t&&(n=i,e(...a))}}function ge(){return import("./hlsjs-C3vtCYGP.js").then((e=>e.a))}const Y=/import\("(.+)"/.exec(ge.toString()),fe=null==Y?void 0:Y[1];let Ee;if(fe){const e=new URL("https://static01.nyt.com/video-static/betamax/",window.location.href);Ee=new URL(fe,e).href}const ve=Ee;function Se(e){return""!==e.canPlayType(ne.hls)}function Pe(e){var t;return null!=(t=e[0])&&t.type.startsWith("hls")?e[0]:void 0}function be(e){return!!Pe(e)&&e.every((e=>e.type.startsWith("hls")))}function Tt(e,t){return be(t)&&!1===Se(e)}function xt(e,t,n){const a=Pe(e),[,i]=W(),r=be(e);if(t&&r){const e="(min-device-width: 450px) and (pointer: fine)";ve&&Z({href:ve,as:"script",rel:"modulepreload",media:e}),Z({href:le,as:"script",rel:"modulepreload",media:e})}C((()=>{if(!r||!a||!n.value)return;const e=n.value;if(Se(e))return;const t=new URL(le,import.meta.url);!async function(){const{default:n}=await ge(),r=new n({workerPath:t.href});r.attachMedia(e),r.loadSource(a.src),r.on(n.Events.ERROR,((e,t)=>{N("HLSJS error",e,t),t.fatal&&i(O(`HLS.js error: ${e}`,{cause:t,type:t.type===n.ErrorTypes.NETWORK_ERROR?"network":"render"}),!0)}))}()}))}const _t={240:"f2",360:"f3",480:"f4",720:"f5",1080:"f1"},Lt=/^\/video\/hls(fmp4)?\/[0-9]{4}\/[0-9]{2}\/[0-9]{2}\/(.+)\/master.m3u8$/;function ke(e){return"vp.nyt.com"===e.host&&Lt.test(e.pathname)}function Te(e,t){if(!1===ke(e))throw new Error("Cannot get resolution-specific playlist for a non-standard NYT video URL");return new URL(`./index-${_t[t]}-v1-a1.m3u8`,e)}const Ct={240:385134,360:802517,480:1532705,720:2595974,1080:3837501};function Rt(e,t,n){const a=["#EXTM3U"];for(const i of n){const n=Ct[i],r=Math.round(i*t),o=t>1?`${i}x${r}`:`${r}:${i}`,s=Te(e,i);a.push(`#EXT-X-STREAM-INF:PROGRAM-ID=1,CODECS="avc1.4d401f,mp4a.40.2",BANDWIDTH=${n},RESOLUTION=${o},VIDEO-RANGE=SDR`,s.href)}return new URL(`data:${ne.hls},`+encodeURIComponent(a.join("\n")))}function Mt(e,t,n=[]){return 0===n.length?e:1===n.length?Te(e,n[0]):Rt(e,t,n)}function ee(e){if("number"==typeof e)return e;const t=/^([0-9]+(?:\.[0-9]+)?)[:/]([0-9]+(?:\.[0-9]+)?)$/.exec(e);if(!t)throw new Error("Could not parse aspect ratio string: "+e);return parseFloat(t[1])/parseFloat(t[2])}const ne={hls:"application/vnd.apple.mpegurl",hlsfmp4:"application/vnd.apple.mpegurl",mp4:"video/mp4"};function z(e){return"hls"!==e.type&&"hlsfmp4"!==e.type&&"height"in e&&"width"in e}function Dt(e){return("hls"===e.type||"hlsfmp4"===e.type)&&"filterQuality"in e}function It(e,t){return e.map((function(e){if(!Dt(e))return e;const n=new URL(e.src);return!1===ke(n)?e:{type:"hls"===e.type?"hls":"hlsfmp4",src:Mt(n,t,e.filterQuality).href}}))}function Vt(e){if(z(e)){if(e.width>=1620)return"(min-resolution: 3x) and (min-width: 540px), (min-resolution: 2x) and (min-width: 810px), (min-width: 1620px)";if(e.width<1620&&e.width>=1080)return"(min-resolution: 3x) and (min-width: 360px), (min-resolution: 2x) and (min-width: 540px), (min-width: 1080px)";if(e.width<1080&&e.width>=720)return"(min-resolution: 3x) and (min-width: 240px), (min-resolution: 2x) and (min-width: 360px), (min-width: 720px)";if(e.width<720&&e.width>=608)return"(min-resolution: 3x) and (min-width: 203px), (min-resolution: 2x) and (min-width: 304px), (min-width: 608px)";if(e.width<608&&e.width>=540)return"(min-resolution: 2x) and (min-width: 270px), (min-width: 540px)";if(e.width<540&&e.width>=404)return"(min-resolution: 2x) and (min-width: 202px), (min-width: 404px)";if(e.width<404&&e.width>=360)return"(min-resolution: 2x) and (min-width: 180px), (min-width: 360px)";if(e.width<360&&e.width>=270)return"(min-resolution: 2x) and (min-width: 135px), (min-width: 270px)";if(e.width<270&&e.width>=202)return"(min-width: 202px)";if(e.width<202&&e.width>=134)return"(min-width: 134px)"}}function Ut({source:e,fallback:t=!1,startTime:n=0,onError:a}){const i=n&&n>0?e.src+`#t=${n}`:e.src;return m("source",{key:e.src,type:ne[e.type],src:i,media:t?void 0:Vt(e),onError:a})}function Nt(e){const t=new URL(e);return t.pathname.endsWith(".mp4")?{type:"mp4",src:e}:t.pathname.endsWith(".m3u8")?{type:t.href.includes("hlsfmp4")?"hlsfmp4":"hls",src:e}:(console.warn("[BETAMAX] could not parse source, don't recognize mime type, defaulting to mp4",e),{type:"mp4",src:e})}function xe(e){return void 0===e?[]:"string"==typeof e?[Nt(e)]:e instanceof Array?e:[e]}function _e(e){return e.sort(((e,t)=>"hlsfmp4"===e.type&&"hlsfmp4"!==t.type?-1:"hlsfmp4"!==e.type&&"hlsfmp4"===t.type?1:"hls"===e.type&&"hls"!==t.type?-1:"hls"!==e.type&&"hls"===t.type?1:z(e)&&z(t)?(t.height??0)-(e.height??0):0))}function Ot(e){const t=e.filter((e=>"hls"!==e.type&&"hlsfmp4"!==e.type));return _e(t)[t.length-1]}function Ft(e,t){const[n,a]=j((()=>{const t=xe(e.src),n=new Set(t.map((e=>new URL(e.src).host)));return[_e(It(t,ee(e.aspectRatio))),n]}),[e.src,e.aspectRatio]);return 1===a.size&&Z({rel:"preconnect",href:"https://"+a.values().next().value}),xt(n,e.visibleOnPageLoad??!1,t),j((()=>{const e=Ot(n);return[...n,e?{...e,fallback:!0}:void 0].filter((e=>void 0!==e))}),[n])}const At={MEDIA_ERR_ABORTED:1,MEDIA_ERR_NETWORK:2,MEDIA_ERR_DECODE:3,MEDIA_ERR_SRC_NOT_SUPPORTED:4};class Ht{constructor(e,t,n){if(p(this,"video"),p(this,"videoProps"),p(this,"eventSender"),p(this,"eventsToTrack"),p(this,"observer",null),p(this,"hasEnded",!1),p(this,"numberOfLoopsCompleted",0),p(this,"hasPaused",!1),p(this,"betamaxVersion","0.1.55"),p(this,"destroy",(()=>{var e;this.detachEventListeners(),null==(e=this.observer)||e.disconnect()})),p(this,"attachEventListeners",(()=>{this.eventsToTrack.forEach((({event:e,handler:t})=>{this.video.addEventListener(e,t)}))})),p(this,"detachEventListeners",(()=>{this.eventsToTrack.forEach((({event:e,handler:t})=>{this.video.removeEventListener(e,t)}))})),p(this,"initIntersectionObserver",(()=>{try{const e=Be(this.video,this.handleIntersectionChange);this.observer={disconnect:e.disconnect}}catch(e){console.warn("Failed to initialize IntersectionObserver:",e)}})),p(this,"handleIntersectionChange",(e=>{e&&e.isIntersecting&&this.sendEvent(d.InView)})),p(this,"sendEvent",((e,t)=>{var n;this.eventSender.send({event:e,payload:{module:"video-player",version:"nyt-betamax",eventName:e,eventTimestamp:Date.now(),referrer:document.referrer,state:this.getState(),networkState:this.video.networkState,readyState:this.video.readyState,mediaErrorCode:t,...this.videoProps.trackingData,mData:{playerType:"nyt-betamax",playerVersion:this.betamaxVersion,device:pe(),devicePixelRatio:window.devicePixelRatio,droppedVideoFramesPercent:this.getDroppedVideoFramesPercent(this.video),renditionFit:this.getRenditionFit(this.video,this.videoProps),videoClientHeight:this.video.clientHeight,videoClientWidth:this.video.clientWidth,videoSourceHeight:this.video.videoHeight,videoSourceWidth:this.video.videoWidth,videoSourceType:this.parseSourceType(this.video),videoDuration:this.videoProps.duration.value?Math.round(this.videoProps.duration.value):0,videoTimeOfEvent:this.videoProps.currentTime.value,aspectRatio:String(this.videoProps.aspectRatio),captionsAvailable:!!this.videoProps.captions,muteEnabled:this.videoProps.muted.value,...null==(n=this.videoProps.trackingData)?void 0:n.mData}}})})),p(this,"getState",(()=>{if(this.video)return"paused"===this.videoProps.playState.value?"paused":this.hasEnded?"completed":"playing"})),p(this,"handleTimeConsumed",kt((()=>{const e=this.videoProps.currentTime.value,t=this.videoProps.duration.value;this.trackPercentageConsumed(e,t),this.trackSecondsConsumed(e),this.trackMinutesConsumed(e)}),500)),p(this,"handleMediaComplete",(()=>{this.hasEnded=!0,this.sendEvent(d.MediaComplete)})),p(this,"handleStalled",(()=>{this.sendEvent(d.Stalled)})),p(this,"handleRebuffering",(()=>{const e=this.videoProps.buffering.value,t=this.video.seeking;e&&!t&&this.sendEvent(d.Rebuffering)})),p(this,"handleSeek",(()=>{const e=Math.round(this.videoProps.currentTime.value),t=Math.round(this.videoProps.duration.value);this.video.loop&&e===t&&this.handleLoopCompletion()})),p(this,"handleLoopCompletion",(()=>{0===this.numberOfLoopsCompleted&&this.handleMediaComplete(),this.numberOfLoopsCompleted++;const{playStateIsUserDriven:e}=this.videoProps,t=null!=e&&e.value?d.UserLoop:d.AutoLoop;this.sendEvent(t)})),p(this,"handleMediaError",(()=>{var e,t,n,a;const i=this.video.error??void 0;let r=`Unknown error, code ${null==i?void 0:i.code}`;if(i)for(const[e,t]of Object.entries(At))if(t===i.code){r=e;break}q(i,{msg:`Error with betamax player component: ${null==(t=null==(e=this.videoProps)?void 0:e.trackingData)?void 0:t.contentId} ${document.location}`,tags:{autoplay:`${this.video.autoplay}`,ended:`${this.video.ended}`,loop:`${this.video.loop}`,media_error_code:`${r}`,muted:`${this.video.muted}`,network_state:`${this.video.networkState}`,paused:`${this.video.paused}`,played:`${this.timeRangeToString(this.video.played)}`,ready_state:`${this.video.readyState}`,seekable:`${this.timeRangeToString(this.video.seekable)}`,seeking:`${this.video.seeking}`,video_id:`${null==(a=null==(n=this.videoProps)?void 0:n.trackingData)?void 0:a.contentId}`,video_state:`${this.getState()}`}}),this.sendEvent(d.MediaError,r)})),p(this,"handleMediaLoad",(()=>{this.numberOfLoopsCompleted>0||this.sendEvent(d.MediaLoad)})),p(this,"handlePlayerLoad",(()=>{this.sendEvent(d.PlayerLoad)})),p(this,"handlePlay",(()=>{const{loop:e}=this.video,{playStateIsUserDriven:t}=this.videoProps;this.hasPaused&&this.sendEvent(d.Resume),this.hasEnded?this.handleReplay(t):!1===(null==t?void 0:t.value)?this.handleAutoplay(e):this.handleManualPlay(e)})),p(this,"handleManualPlay",(e=>{const t=0===Math.round(this.videoProps.currentTime.value);t&&!e?this.sendEvent(d.UserPlay):t&&e&&this.sendEvent(d.UserPlayLoop)})),p(this,"handleReplay",(e=>{!1===(null==e?void 0:e.value)?this.sendEvent(d.AutoPlayNext):this.sendEvent(d.UserPlayNext)})),p(this,"handleAutoplay",(e=>{e?this.sendEvent(d.AutoPlayLoop):this.sendEvent(d.AutoPlayStart)})),p(this,"handleMute",(()=>{this.videoProps.muted.value?this.sendEvent(d.Mute):this.sendEvent(d.Unmute)})),p(this,"handlePause",(()=>{this.hasPaused=!0,this.sendEvent(d.Pause)})),p(this,"handleVideoStop",(()=>{"hidden"===document.visibilityState&&this.sendEvent(d.VideoStop)})),p(this,"parseSourceType",(e=>{const t=e.currentSrc.match(/\.([a-zA-Z0-9]+)$/);return t?"m3u8"===t[1].toLowerCase()?"hls":t[1].toLowerCase():""})),p(this,"getDroppedVideoFramesPercent",(e=>{const t="getVideoPlaybackQuality"in e?e.getVideoPlaybackQuality():null;return t?Math.round(t.droppedVideoFrames/t.totalVideoFrames*100):0})),p(this,"getRenditionFit",((e,t)=>{if(this.getDroppedVideoFramesPercent(e)>=1)return"over";if("hls"===this.parseSourceType(e))return"optimal";const n=xe(t.src).filter((e=>z(e))).sort(((e,t)=>e.width-t.width));if(n.length<=1)return"optimal";const a=e.videoWidth,i=e.clientWidth*window.devicePixelRatio,r=n.filter((e=>e.width<=i)).sort(((e,t)=>t.width-e.width));if(0===r.length)return n.reduce(((e,t)=>t.width<e.width?t:e),n[0]).width===a?"optimal":"over";const o=r[0].width;return a>o?"over":a<o?"under":"optimal"})),!(e&&e instanceof HTMLVideoElement))throw new Error("A valid HTMLVideoElement must be provided");this.video=e,this.videoProps=t,this.eventSender=n,this.eventsToTrack=[{event:k.TimeUpdate,handler:this.handleTimeConsumed},{event:k.Ended,handler:this.handleMediaComplete},{event:k.Waiting,handler:this.handleRebuffering},{event:k.Stalled,handler:this.handleStalled},{event:k.Seeking,handler:this.handleSeek},{event:k.Error,handler:this.handleMediaError},{event:k.CanPlay,handler:this.handleMediaLoad},{event:k.LoadedData,handler:this.handlePlayerLoad},{event:k.Play,handler:this.handlePlay},{event:k.VolumeChange,handler:this.handleMute},{event:k.Pause,handler:this.handlePause}],this.attachEventListeners(),this.initIntersectionObserver()}trackPercentageConsumed(e,t){const n=[{percentage:25,event:d.Percent25Consumed},{percentage:50,event:d.Percent50Consumed},{percentage:75,event:d.Percent75Consumed},{percentage:90,event:d.Percent90Consumed}],a=Math.ceil(e/t*100);n.forEach((({percentage:e,event:t})=>{e<=a&&this.sendEvent(t)}))}trackSecondsConsumed(e){[{seconds:3,event:d.Seconds3Consumed},{seconds:30,event:d.Seconds30Consumed}].forEach((({seconds:t,event:n})=>{t<=e&&this.sendEvent(n)}))}trackMinutesConsumed(e){[{minutes:1,event:d.Minutes1Consumed},{minutes:2,event:d.Minutes2Consumed},{minutes:3,event:d.Minutes3Consumed},{minutes:4,event:d.Minutes4Consumed},{minutes:5,event:d.Minutes5Consumed}].forEach((({minutes:t,event:n})=>{60*t<=e&&this.sendEvent(n)}))}timeRangeToString(e){const t=[];for(let n=0;n<e.length;n++)t.push(`${e.start(n)}-${e.end(n)}`);return t.join(", ")}}const $t=e=>{if(e)return e.paused?"paused":e.ended?"completed":"playing"},te=new bt,Wt=e=>{te.sendCustomEvent(e)};function Bt({element:e,props:t,playStateIsUserDriven:n,playState:a,currentTime:i,duration:r,muted:o,buffering:s}){const l=$(t.trackingData);return C((()=>l.value&&e.value?new Ht(e.value,{...t,playStateIsUserDriven:n,playState:a,currentTime:i,duration:r,muted:o,buffering:s},te).destroy:void 0)),{send:(n,a)=>{var s;if(!l.value)return void console.error("No tracking data provided! will not send event",n);const u=e.value;te.send({event:n,payload:{module:"video-player",version:"nyt-betamax",eventName:n,eventTimestamp:Date.now(),referrer:document.referrer,state:$t(u),...l.value,...a,mData:{playerType:"nyt-betamax",device:pe(),videoDuration:r.value?Math.round(r.value):0,videoTimeOfEvent:i.value,aspectRatio:t.aspectRatio,captionsAvailable:!!t.captions,muteEnabled:o.value,...null==(s=l.value)?void 0:s.mData,...null==a?void 0:a.mData}}})},sendCustomEvent:Wt}}class jt extends Fe{constructor(){super(...arguments),p(this,"state",{hasError:!1})}componentDidCatch(e,t){N(e),q(e,{msg:JSON.stringify(t),tags:{}}),this.props.setErrorState(O(e,{type:"render",cause:e})),this.setState({hasError:!0})}render(){return this.state.hasError?m(me,null):this.props.children}}function zt(){const e=w("visible");return V((()=>{const t=()=>e.value=document.visibilityState;return document.addEventListener("visibilitychange",t),t(),()=>{document.removeEventListener("visibilitychange",t)}}),[e]),e}function qt(e,t){const n=w(void 0),a=w(!1),i=$e(),r=zt(),o=je(t,e.visibleOnPageLoad??!1),s=L((()=>o.value&&"visible"===r.value)),l=w(!0===e.play&&e.visibleOnPageLoad?"playing":"paused"),[,u]=W(),d=w(e.muted??!1),c=w(e.durationInSeconds??0),v=w(!1),p=w(e.startTime??0),h=L((()=>void 0!==n.value)),m=$(e.play||!1),f=L((()=>void 0===n.value?m.value:"play"===n.value)),y=L((()=>{let t=f.value;if(!0===a.value)return!1;const n=e.pauseWhenOutOfView??"when-muted";return(!0===n||"when-muted"===n&&!0===d.value)&&(t=t&&s.value),!1===h.value&&!0===i.value&&(t=!1),t})),g=L((()=>({playValue:y.value,isUserDriven:h.value,currentPlayState:l.value})));return C((()=>{if(!t.value)return;const{playValue:n}=g.value,a=t.value;if(!1===n)return l.value="paused",void a.pause();a.duration&&(c.value=a.duration),a.play().catch((t=>{var n;if(null==(n=e.onPlaybackError)||n.call(e,t),t instanceof Error)switch(t.name){case"NotAllowedError":return void(l.value="paused");case"AbortError":return}u(O(t,{cause:t,type:"playback"}),!0)}))})),{buffering:v,currentTime:p,duration:c,autoPlay:e.visibleOnPageLoad&&y.value,playState:l,muted:d,setUserDrivenPlaystate:e=>{n.value=e,"play"===e&&(a.value=!1)},receivedBrowserPauseEvent:()=>{!1!==y.value&&"hidden"!==document.visibilityState&&(a.value=!0)},playStateIsUserDriven:h}}const Gt="_buffering-spinner_58d5h_11",Jt="_spinner_58d5h_28",K={bufferingSpinner:Gt,spinner:Jt};function Yt(e){const t=null!==he().value;if(!1!==e.buffering.value&&!0!==t)return m("div",{className:K.bufferingSpinner,role:"alert","aria-label":"Loading"},m("div",{className:K.cover}),m("div",{className:K.spinner},Array(12).fill(0).map(((e,t)=>m("span",{key:t})))))}function Kt(e,t,n,a){const i=w(null),r=w(null),o=w(!1),s=w(!1),l=L((()=>"playing"===t.value||n.value>0));return C((()=>{if(!e.value)return;const t=e.value,n=()=>{i.value=t.textTracks[0]};return t.textTracks.addEventListener("change",n),n(),()=>t.textTracks.removeEventListener("change",n)})),C((()=>{if(!i.value||!0===o.value||!1===l.value)return void(r.value=[]);const e=i.value;e.mode="hidden";const t=()=>{r.value=e.activeCues?Array.from(e.activeCues):null};return e.addEventListener("cuechange",t),t(),()=>{e.removeEventListener("cuechange",t),e.mode="showing"}})),{forceNativeCaptions:o,activeCaptions:L((()=>{var e;if(!1===a.value)return null;const t=null==(e=r.value)?void 0:e[0];return t?{startTime:t.startTime,endTime:t.endTime,text:t.text}:null})),captionsAvailable:s}}const Qt="_captionsDisplay_xgk3v_1",Xt="_cueWrap_xgk3v_12",Zt="_caption_xgk3v_1",Q={captionsDisplay:Qt,cueWrap:Xt,caption:Zt};function en({captions:e}){return e.value?m("div",{"data-testid":"captions-display",className:Q.captionsDisplay},m("div",{className:Q.cueWrap},m("p",{className:Q.caption},e.value.text))):null}function tn(e){const t=U(null);return V((()=>{const n=t.current;if(n)return a(),n.addEventListener("load",a),()=>{n.removeEventListener("load",a)};function a(){2===(null==n?void 0:n.readyState)&&(e.captionsAvailable.value=!0)}}),[]),e.captions?m("track",{"data-testid":"betamax-caption-element",ref:t,src:e.captions,label:"English",kind:"captions",srcLang:"en",default:!0}):null}function nn(){const e=w(!1);return V((()=>{e.value=!0}),[e]),e}function rn(e){var t,n,a;const i={},{ignoreGlobalState:r}=e;try{const t=ee(e.aspectRatio);i["--video-aspect-ratio"]=String(t)||""}catch(e){console.error("[Betamax error]",e)}const o=w(null),[,s]=W(),{autoPlay:l,buffering:u,currentTime:d,duration:c,playState:v,playStateIsUserDriven:p,setUserDrivenPlaystate:h,receivedBrowserPauseEvent:f,muted:y}=qt(e,o),g=U(null),{events:E}=vt({playState:v,muted:y,currentTime:d,duration:c,buffering:u,receivedBrowserPauseEvent:f,setUserDrivenPlaystate:h},{onCanPlay:e.onCanPlay,onPause:e.onPause,onPlay:e.onPlay});ct({enabled:!r||!r.includes("pause"),videoElementRef:o,live:!1,playState:v,setUserDrivenPlaystate:h});const b=Bt({element:o,props:e,playStateIsUserDriven:p,playState:v,currentTime:d,duration:c,muted:y,buffering:u}),P=!r||!1===r.includes("mute");lt(o,P,v);const k=Ft(e,o),S=w(!0),{activeCaptions:x,forceNativeCaptions:T,captionsAvailable:C}=Kt(o,v,d,S),{fullScreenSignal:D,setFullscreen:R}=yt(g,o,v,T,h),M=null==(t=X("nyt-betamax-pool"))?void 0:t.pool,I=j((()=>(null==M?void 0:M.VideoRenderer)??ze),[M]),A=nn(),F=L((()=>{const e=[];return!0===A.value&&e.push(_.reducedMotionCheckComplete),e}));return m("div",{className:H(_.container,"container-target",{[_.fullscreen]:D.value,[_.fitContain]:"contain"===e.fit,[_.fitCover]:"cover"===e.fit}),style:i,ref:g,"data-testid":"betamax-player",role:"group","aria-label":null!=(a=null==(n=e.trackingData)?void 0:n.mData)&&a.videoName?`${e.trackingData.mData.videoName} video`:"Video player"},m(Et,{videoElement:o,currentTime:d,duration:c,fullscreenSignal:D,muted:y,playState:v,playStateIsUserDriven:p,setFullscreen:R,setUserDrivenPlaystate:h,tracking:b,buffering:u,aspectRatio:ee(e.aspectRatio),visibleOnPageLoad:!!e.visibleOnPageLoad,captions:S,captionsAvailable:C},m(jt,{setErrorState:s},m(me,null),m("div",{className:_.video},m(I,{signal:o,className:H(F.value),muted:e.muted,autoPlay:l,loop:e.loop,crossOrigin:"anonymous",playsInline:!0,...E,preload:"none"},k.map(((t,n,a)=>m(Ut,{key:t.src,source:t,startTime:e.startTime,fallback:"fallback"in t&&t.fallback,onError:n===a.length-1&&o.value&&!1===Tt(o.value,k)?e=>{N("source tag error",e),s(O("No video sources found in source",{type:"network",cause:e}),!0)}:void 0}))),m(tn,{captions:e.captions,captionsAvailable:C})),m(en,{captions:x}),m(Yt,{buffering:u})),m(He,null))))}function an(e){return m(We,null,m(rn,{...e}))}const vn=Ae(F,{"css":["https://static01.nyt.com/video-static/betamax/player-0.1.55-ChS-m6k8.css"],"js":[{"src":"https://static01.nyt.com/video-static/betamax/player-0.1.55-Ct1__drg.js","entry":true},{"src":"https://static01.nyt.com/video-static/betamax/betamax-shared-DH_j5-1B.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/reduced-motion-rPScagHf.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/event-types-ylPu1rr5.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/video-element-BevtQ4YC.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/identify-user-NlIHKxju.js","entry":false}]},an);export{vn as Betamax,F as TAG_NAME};
//# sourceMappingURL=player-0.1.55-Ct1__drg.js.map