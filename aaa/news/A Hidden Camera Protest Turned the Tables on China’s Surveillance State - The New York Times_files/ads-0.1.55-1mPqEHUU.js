var H=Object.defineProperty,J=(e,t,n)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,I=(e,t,n)=>J(e,"symbol"!=typeof t?t+"":t,n);import{u as N,d as R,y as B,f as Y,a as Q,c as X,_ as T,k as Z,b as ee,A as V,e as O}from"./betamax-shared-DH_j5-1B.js";import{S as p}from"./event-types-ylPu1rr5.js";import{g as te,a as re}from"./identify-user-NlIHKxju.js";const ne="_ads-container_yrjkj_10",ae="_active_yrjkj_22",oe="_controls_yrjkj_47",se="_ctlBtnClass_yrjkj_93 _buttonBase_yrjkj_61",ie="_icon_yrjkj_103",de="_muted_yrjkj_112",ce="_unmuted_yrjkj_116",b={adsContainer:ne,active:ae,controls:oe,ctlBtnClass:se,icon:ie,muted:de,unmuted:ce};function ue(){var e;const t=null==(e=N("nyt-betamax"))?void 0:e.player;if(!t)throw new Error("Could not get betamax context");const[n,r]=R(void 0);return B((()=>{const e=document.createElement("script");e.onload=()=>{r(window.google.ima)},e.onerror=e=>{console.error("[nyt-betamax-ads] Could not load IMA SDK",e),t.tracking.sendCustomEvent({event:p.AdError,eventData:{trigger:"ad",type:"ad-error"},ad:{position:"preroll",slotId:"preroll",mData:{videoType:"ad",adEnabled:!0,adPosition:"preroll",adErrorMessage:"IMA SDK failed to load"}}})},e.src="https://imasdk.googleapis.com/js/sdkloader/ima3.js",document.head.appendChild(e)}),[]),n}class le{constructor(e){var t,n,r;I(this,"currentPageUrl"),I(this,"_url"),this.currentPageUrl=e.url??(null==(t=document.querySelector('link[rel="canonical"]'))?void 0:t.getAttribute("href"))??(null==(n=document.querySelector('meta[name="url"]'))?void 0:n.getAttribute("content"))??(null==(r=null==window?void 0:window.location)?void 0:r.href)??"";const a=this.currentPageUrl.split("?")[0],o="npa"===e.purr?1:0,d="rdp"===e.purr?1:0,i="ltd"===e.purr?1:0,s=e.muted?1:0,l=e.autoPlay?"auto":"click",u=e.autoPlay?"2":"1";this._url=`https://securepubads.g.doubleclick.net/gampad/ads?\n        env=vp\n        &gdfp_req=1\n        &impl=s\n        &unviewed_position_start=1\n        &iu=${this.getIu(e)}\n        &output=xml_vmap1\n        &sz=${this.getSz(e.width,e.height,e.mediaRatio)}\n        &url=${a}\n        &description_url=${encodeURIComponent(a)}\n        &correlator=${Date.now()}\n        &cmsid=1958\n        &vid=${e.mediaId}\n        &cust_params=${this.formatCustParams(this.getCustParams(e))}\n        &npa=${o}\n        &rdp=${d}\n        &ltd=${i}\n        &vpa=${l}\n        &vpmute=${s}\n        &vid_d=${e.mediaDuration}\n        &plcmt=${u}\n        `.replace(/\s/g,"")}get url(){return this._url}getIu(e){var t,n;if(null!=(t=e.adReq)&&t.path)return e.adReq.path;const r=null==(n=e.playlist)?void 0:n.slug,a=e.isSectionFront,o="29390238/"+("production"===e.env?"nyt":"zznyt");return r?`${o}/${r.replace(/\W/g,"").toLowerCase()}`:a?`${o}/sectionfront`:o}getSz(e,t,n){const r=["480x360","480x361","640x480"];return te().includes("nytios")?r.join("|"):[`${Math.round(e)}x${Math.round(t)}`,...{"16:9":["640x360","1280x720"],"4:3":["640x480"],"9:16":["360x640","720x1280"],"2:3":["720x1080"]}[n]||[],...e>t?["300x250","400x300"]:["320x480","480x480","720x720"],...r].join("|")}getCustParams(e){const t=this.computeAspectRatio(e.mediaRatio)>100,{path:n,...r}=e.adReq||{};let a=r||{};const o=new URL(this.currentPageUrl).searchParams.get("ad-keywords");a.adv=null!==o?o:r.adv||"",a.audio=e.muted?"muted":"unmuted",a.autoplay=e.autoPlay?"yes":"no",a.noads=e.mediaAds?"no":"yes",a.pos=t?"vidv":"vidh",a.section=e.mediaSection,a.subsection=e.mediaSubsection,a.videoser=e.mediaSeries,a.vidid=e.mediaId,a.viddur=this.getViddur(e.mediaDuration),a.plat=a.plat||this.getPlatform(),a.prop=a.prop||this.getProperty(this.currentPageUrl),a.typ=a.typ||this.getType(),a.id=a.id||this.getMetaValues("articleid").join(""),a.ver=a.ver||this.getVer(),a.col=a.col||this.getMetaValues("col").join(",").toLowerCase().replace(/\s+|\W/g,"");const d=this.getCustParamsFromTimesTags(e);return a={...a,...d||{}},a}formatCustParams(e){const t=Object.keys(e).filter((t=>!!e[t])).map((t=>`${t}=${e[t]}`));return encodeURIComponent(t.join("&"))}computeAspectRatio(e){let t=56.25;if("none"===e)return 0;if("string"!=typeof e)return t;const n=e.split(":").map(Number);return 2===n.length&&(t=Math.round(n[1]/n[0]*1e4)/100),t}getViddur(e){if(e){if(e>=240)return"long";if(e>=60)return"medium";if(e>=30)return"semishort";if(e>0)return"short"}return"none"}getPlatform(){return"desktop"===re()?"web":"mweb"}getProperty(e){return new URL(e).host.indexOf("cooking.nytimes.com")>-1?"cookweb":"nyt"}getType(){const e=this.getMetaValues("sourceApp").join(""),t=this.getMetaValues("PT").join(""),n=this.getMetaValues("applicationName").join("");return"nytcooking"===e?"rec":"nytv"===e?"vidlib":"Homepage"===t?"hp":"collection"===n?"coll":"interactive"===n?"int":"Section Front"===t?"sf":"article"===t?"art":"Blogs"===t?"bl":"guide"===t?"gui":""}getMetaValues(e){const t=[],n=document.getElementsByTagName("meta");for(let r=0;r<n.length;r++)n[r].name===e&&t.push(n[r].content);return t}getVer(){const e={"nyt-v5":"nyt5",nytv:"timesvideo",mobileWeb:"mweb"},t=this.getMetaValues("sourceApp").join("");return t&&e[t]?e[t]:""}getCustParamsFromTimesTags(e){const{mediaTimesTags:t}=e;if(!t)return null;const n={vidbrandsensitive:"false"},r={organization:"vidorg",location:"vidgeo",person:"vidper",title:"vidttl",subject:"viddes",keyword:"vidspon"};return t.forEach((e=>{const{vernacular:t,displayName:a,isAdvertisingBrandSensitive:o,__typename:d}=e,i=a||t,s=i?this.formatTimesTagValue(i):null,l=d?d.toLowerCase():null,u=l&&r[l];s&&u&&n[u]?n[u]=`${n[u]},${s}`:s&&u&&(n[u]=s),o&&(n.vidbrandsensitive="true")})),n}formatTimesTagValue(e){return"string"==typeof e?e.toLowerCase().replace(/\s+|\W/g,"").substring(0,30):null}}function me(){return typeof document>"u"?null:Y().PURR_AdConfiguration_v4}const j="nyt-betamax-ads",D=`${j}-interceptor`,m=Q(j);function ge(e,t,n){const{settings:r,ImaSdkSettings:a,AdDisplayContainer:o,AdsLoader:d}=e;r.setVpaidMode(a.VpaidMode.DISABLED),r.setDisableCustomPlaybackForIOS10Plus(!0);const i=new o(t,n),s=new d(i);return i.initialize(),m("Ad display container initialized"),{adDisplayContainer:i,adsLoader:s}}function pe(e){const{autoPlay:t,height:n,ima:r,playerContext:a,props:o,width:d}=e,i=r.settings;"ppid"in o&&i.setPpid(o.ppid??"");const s=new r.AdsRequest;return s.setAdWillAutoPlay(t),s.setAdWillPlayMuted(a.muted.value),s.linearAdSlotWidth=d,s.linearAdSlotHeight=n,s.nonLinearAdSlotWidth=d,s.nonLinearAdSlotHeight=n,s.adTagUrl="overrideAdURL"in o?o.overrideAdURL:new le({...o,autoPlay:t,height:n,mediaDuration:a.duration.value,muted:a.muted.value,width:d}).url,m("Ad request created",s.adTagUrl),s}function f({adErrorMessage:e,adType:t,ev:n,eventName:r,playerContext:a}){var o;try{const d=null==n?void 0:n.getAd();null==(o=a.tracking)||o.send(r,{mData:{videoType:"ad",adEnabled:!0,adPosition:"preroll",adDuration:String(null==d?void 0:d.getDuration()),adType:t,adId:null==d?void 0:d.getAdId(),adErrorMessage:e||void 0}})}catch(e){console.error("Error tracking ad event",e)}}function ve({AdEvent:e,adsManager:t,adDisplayContainer:n,lowLevelContext:r,onAdEnd:a,resizeObs:o,playerContext:d,setAdVisible:i}){return function s(){i(!1),null==a||a(),r.unregisterPlaybackInterceptor(D),m("Playback interceptor unregistered because ad completed"),d.play(),t.removeEventListener(e.Type.COMPLETE,s),t.destroy(),o.disconnect(),n.destroy(),m("Ad playback complete")}}function fe({AdErrorEvent:e,AdEvent:t,AdsRenderingSettings:n,adDisplayContainer:r,adProps:a,adWillAutoPlay:o,adsManagerRef:d,lowLevelContext:i,height:s,playerContext:l,setAdVisible:u,videoElement:c,width:v,onAdEnd:y,onAdStart:g}){return function(A){m("AdsManager loaded");const E=new n;E.useStyledLinearAds=!0;const h=A.getAdsManager(c,E);d.current=h;const b=a&&"purr"in a?a.purr:void 0;f({eventName:p.AdManagerLoaded,playerContext:l,adType:b});const C=new ResizeObserver((e=>{for(const t of e)h.resize(t.contentRect.width,t.contentRect.height)}));C.observe(c),h.addEventListener(t.Type.LOADED,(function(e){m("Ad video loaded"),f({eventName:p.AdLoaded,playerContext:l,adType:b,ev:e})})),h.addEventListener(t.Type.STARTED,(function(e){m("Ad started"),null==g||g(),f({eventName:o?p.AdAutoPlayStart:p.AdUserPlayNext,playerContext:l,adType:b,ev:e})})),h.addEventListener(t.Type.AD_BUFFERING,(function(e){m("Ad buffering"),f({eventName:p.AdBuffering,playerContext:l,adType:b,ev:e})})),h.addEventListener(t.Type.IMPRESSION,(function(e){m("Ad impression"),f({eventName:p.AdImpression,playerContext:l,adType:b,ev:e})})),h.addEventListener(t.Type.PAUSED,(function(e){m("Ad paused"),f({eventName:p.AdPause,playerContext:l,adType:b,ev:e})})),h.addEventListener(t.Type.RESUMED,(function(e){m("Ad resumed"),f({eventName:p.AdResume,playerContext:l,adType:b,ev:e})}));const T=ve({AdEvent:t,adsManager:h,adDisplayContainer:r,lowLevelContext:i,resizeObs:C,playerContext:l,setAdVisible:u,onAdEnd:y});h.addEventListener(t.Type.COMPLETE,(function(e){m("Ad completed"),f({eventName:p.AdComplete,playerContext:l,adType:b,ev:e}),T()})),h.addEventListener(t.Type.SKIPPED,(function(e){m("Ad skipped"),f({eventName:p.AdSkip,playerContext:l,adType:b,ev:e}),T()})),h.addEventListener(e.Type.AD_ERROR,(function(e){console.error("Ad error",e.getError()),f({eventName:p.AdError,playerContext:l,adType:b,adErrorMessage:"AdsManager error"}),T()})),h.addEventListener(t.Type.ALL_ADS_COMPLETED,(function(e){m("Ad completed (all ads done or no valid ads)"),f({eventName:p.AdComplete,playerContext:l,adType:b,ev:e}),T()})),h.addEventListener(t.Type.LOG,(function(e){const t=e.getAdData(),n=t&&"adError"in t?t.adError:void 0;n&&m("Ad log: Non-fatal error occurred: "+n.getMessage())})),u(!0),h.init(v,s),h.start(),m("AdsManager: Ad started")}}function ye(e){var t,n;const r=null==(t=N("nyt-betamax"))?void 0:t.lowLevel,a=null==(n=N("nyt-betamax"))?void 0:n.player;if(!r||!a)throw new Error("Could not get betamax context");const[o,d]=R(null);ee((()=>{d(r.videoElement.value)}));const i=V(null),[s,l]=R(!1),u=V(null),[c,v]=R(!1),y=ue();B((()=>{if(!o||!y||!i.current||u.current||c)return;const t=(n=o,d=y,s=e,g=i.current,A=u,()=>{if(A.current)return{allowPlayback:!1,reason:"Ad already instantiated"};try{v(!0);const{AdsManagerLoadedEvent:e,AdEvent:t,AdErrorEvent:o,AdsRenderingSettings:i}=d,{adDisplayContainer:u,adsLoader:c}=ge(d,g,n);c.addEventListener(d.AdErrorEvent.Type.AD_ERROR,(e=>{l(!1),console.error("Ads loader error",e.getError()),f({eventName:p.AdError,playerContext:a,adType:"purr"in s?s.purr:void 0,adErrorMessage:"AdsLoader error"}),r.unregisterPlaybackInterceptor(D),m("Playback interceptor unregistered due to ads loader error"),a.play()}));const{width:y,height:E}=n.getBoundingClientRect(),h="playing"===a.playState.value&&!1===r.playStateIsUserDriven.value,b=pe({autoPlay:h,height:E,ima:d,playerContext:a,props:s,width:y});return c.addEventListener(e.Type.ADS_MANAGER_LOADED,fe({AdErrorEvent:o,AdEvent:t,AdsRenderingSettings:i,adsManagerRef:A,adDisplayContainer:u,adProps:s,adWillAutoPlay:h,height:E,lowLevelContext:r,playerContext:a,setAdVisible:l,videoElement:n,width:y,onAdEnd:s.onAdEnd,onAdStart:s.onAdStart})),c.requestAds(b),{allowPlayback:!1,reason:"Ad needs to display"}}catch(e){return console.error("Error launching ad",e),{allowPlayback:!0}}});var n,d,s,g,A;return r.registerPlaybackInterceptor(D,t),m("Playback interceptor registered"),()=>{r.unregisterPlaybackInterceptor(D),m("Playback interceptor unregistered via cleanup")}}),[o,y,i.current,e]);const g=!0===a.muted.value?"Unmute":"Mute",A=!0===a.muted.value?b.muted:b.unmuted;return T("div",{ref:i,className:O(b.adsContainer,s&&b.active)},T("div",{className:b.controls},T("button",{onClick:function(){if(a){const e=!a.muted.value;a.setMuted(e),u.current&&u.current.setVolume(e?0:1)}},"aria-label":g,className:b.ctlBtnClass},T("span",{className:O(b.icon,A)}))))}function Ae(e){const t=me();return null===t||"no-ads"===t?T(Z,null):T(ye,{...e,purr:t})}const _e=X(j,{"css":["https://static01.nyt.com/video-static/betamax/ads-0.1.55-CzkoJdsp.css"],"js":[{"src":"https://static01.nyt.com/video-static/betamax/ads-0.1.55-1mPqEHUU.js","entry":true},{"src":"https://static01.nyt.com/video-static/betamax/betamax-shared-DH_j5-1B.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/event-types-ylPu1rr5.js","entry":false},{"src":"https://static01.nyt.com/video-static/betamax/identify-user-NlIHKxju.js","entry":false}]},Ae);export{_e as BetamaxAds,pe as getAdRequest,ve as handleAdCompleteEvent,fe as handleAdsLoaderEvent,f as trackAdEvent};
//# sourceMappingURL=ads-0.1.55-1mPqEHUU.js.map